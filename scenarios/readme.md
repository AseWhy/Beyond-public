# Сценарии
Папка с шаблонами сценариев, для шаблонов имя обязательно должно иметь расширение `.json`.
В шаблонах можно писать коммантарии, которые парсятся так-же как и json:
```jsonc
    // Somecomment
    /*
        Multiline
    */
```

### Структура сценариев
Объект сценария это объект который вы зодаете в своем json вида 
```jsonc
{
    "name": "Регистрация",      // Обязательное поле
    "id": "registration",       // Обязательное поле
    "use_state": true,          // Если не выставить, будет false, если state, то не будет происходить изсенение sate в независимости от наличия state во вхождении
    "user_character": false,    // Если false, то поля character.* будут недоступны
    "preset": {                 // Пресет с настройками (Важно выставить в самом начале, в дальнейшем добавить поля не получится)
        "sex": null,        
        "origin": null,
        "sity": null,
        "name": null
    },
    "condition": {          // Условие
        "key": "user[isRegistred]",
        "value": false,
        "operator": "="
    },
}
```

#### Пресет параметров
Прессет сценария это поле которое говорит о структуре данных сценария, допустим в процессе регистрации нам необходибо получить пол, имя, происхождение, и стартовый город, соответсвенно пресет будет такой как указан выше:
```jsonc
{
    "preset": {
        "sex": null,        
        "origin": null,
        "sity": null,
        "name": null
    }
}
```

#### Условия
Условие может быть одиночным, а может и группой условий. Для группы условий возможно вложение одной группы в другую. Пример условия:
```js
    command.arg[0] = 'кмд1'
```
Пример группы условий:
```js
    command.arg[0] = 'кмд1' | command.arg[0] = 'кмд2' & 4 = 4
```
Для простоты понимания это эквивалентно:
```js
    (command.arg[0] = 'кмд1') или ((command.arg[0] = 'кмд2') и (4 = 4))
```
Обратите внимание оператор и (&) по приоритету выше чем или (|), выражения с и выполняются даже если выражение входит в действие оператора или.

#### список доступных параметров (Динамических)
| Название           | Тип        | Описание                                                        |
| ------------------ |:---------- | --------------------------------------------------------------- |
| `state`            | **Number** | текущая стадия исполнения сценария                              |
| `command.type`     | **String** | тип команды, которая обрабатывается в данный момент [`message`, `payload`] |
| `command.header`   | **String** | заголовок команды, которая обрабатывается в данный момент       |
| `command.arg[KEY]` | **Any**    | аргумент с ключем ***KEY***                                     |
| `user[KEY]`        | **Any**    | параметр пользователя с ключем ***KEY***                        |
| `character.name`              | **String**    | Имя персонажа                                     |
| `character.owner`             | **String**    | id пользователя, который владеет персонажем       |
| `character.origin`            | **String**    | Происхождение персонажа                           |
| `character.id`                | **Number**    | Идентификатор персонажа                           |
| `character.state.state`       | **Number**    | Текущее состояние персонажа                       |
| `character.state.data[KEY]`   | **Any**       | параметр состояния персонажа с ключем **KEY***    |

### Вхождения
Вхождения, вхождения определяют какое действие будет исполнятся в текущий момент. Вхождения исполняются сверху вниз, и перебераются все вхождения. Если находится вхождение которое будет срабатывать в управление передается этому вхождению. Пример, есть список вхождений `написать сообщение` `сохранить параметры` `написать сообщение`, из них перебраны будут все, а срабатывать они будут в зависимоти от условия. Так-же вхождению можно передать параметр `break_on`, который отвечает за то, чтобы после выполнения вхождения цикл исполнения заканчивался. Парамеры вхождения
| Название    | Тип           | Описание                 |
| ----------- | ------------- | ------------------------ |
| `type`      | **String**    | Определяет тип вхождения |
| `break_on`  | **Boolean**   | Если `true`, то выполнение сценария на этом будет прекращено **Важно** Для этого нужно чтобы именно вхождение было исполнено.   |
| `condition` | **Condition** | Условие исполнения       |
| `state`     | **Number**    | Насколь будет продвинут прогресс у сценария, после исполнения этого вхождения. т.е. это число просто прибавится к state пользователя |

### Типы вхождений
Для вхождений существуют типы, на данный момент два. Типы это своего рода функции, напиши пользователю, запиши в базу и т.д. Все типы наследуются от базового вхождения, поэтому могут принимать те-же параметры что и базовое вхождение.

#### Сохранить
Тип который сохраняет параметры в базу, в соответсвии со стартовым пресетом `save` так-же может принимать следующие парметры
| Название    | Тип           | Описание                 |
| ----------- | ------------- | ------------------------ |
| `entries`   | **Object**    | {"`key`": "`value`"} параметров, которые будут записаны в базу. Для значений так-же допустимо применение таблицы **список доступных параметров (Динамических)**|

#### Вывести
Тип который выводит сообщение пользователю `write` так-же может принимать следующие парметры. Если сообщение выходит длиннее чем 4096 символов, система автоматически разобъет это сообщение на части длинной 4096, и отправить кусками, в последнем сообщении будут содержатся все вложения клавиатура.
| Название    | Тип        | Описание                   |
| ----------- | ---------- | -------------------------- |
| `message`   | **String**\|**Array** | Сообщение пользователю, может принимать массив, каждый элемент массива в таком случае будет новой строкой              |
| `keyboard`  | **Array**  | Клавиатура (*Опционально*) |

##### Клавиатура
Клавиатура выдается в виде массива, [ Button, Buttn ] Конопок, кнопки меют следующие параметры
| Название  | Тип         | Описание                                        |
| --------- | ----------- | ----------------------------------------------- |
| `title`   | **String**  | Заголовок (Текст на кнопке)                     |
| `payload` | **Object**  | Команда боту при нажатии см. *Payload Стандарт* |
| `color`   | **String**  | Цвет (*Опционально*)                            |

##### Payload Стандарт
Для `playload` в проекте будет свой стандарт, он должен содержать слующие поля
| Название  | Тип         | Описание                                        |
| --------- | ----------- | ----------------------------------------------- |
| `header`  | **String**  | Заголовок (Обычно название сценария)                     |
| `data`    | **Object**\|**Array**\|**Null**  | Массив или объект который мы получим в следующем сообщении в виде message |

**Важно!** При получении сообщения вида нажатия на кнопку, у сообщения будет тип payload.

### Шаблонизатор
На данный момент шаблонизатор распостраняется на все вхождения типа `write`, на поля `message`. Шаблонизатор имеет несколько возможностей вызов функций имя.функции(`arg1`,`arg2`...), получение системных переменных имя.переменной, через точку как операнд доступа к полям, так-же для итерируемых элементов возможен доступ через [i] где i индекс элемента. И тернарные выражения <`expression`> ? **c** : **d**;
